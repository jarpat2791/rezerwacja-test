<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalendarz miesiąca - Rezerwacje aut</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
	  <link rel="icon" type="image/x-icon" href="favicon.ico">
	<link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Dodatkowe style dla kalendarza miesiąca */
        .month-calendar-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .month-title {
            color: #2a5298;
            font-size: 1.5rem;
            margin: 0;
        }

        .btn-nav {
            padding: 10px 20px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .btn-nav:hover {
            background: #1a3a78;
        }

        .multi-calendar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .multi-calendar-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .multi-calendar-grid {
                grid-template-columns: 1fr;
            }
        }

        .car-calendar {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }

        .car-calendar-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2a5298;
        }

        .car-calendar-header h3 {
            margin: 0;
            color: #2a5298;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .month-calendar-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .month-calendar-table th {
            background: #e9ecef;
            color: #495057;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 5px 2px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .month-calendar-table td {
            height: 35px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
            padding: 2px;
        }

        .month-calendar-table td.empty-cell {
            background: #f8f9fa;
        }

        .month-calendar-table td.available {
            background: #d4edda;
            color: #155724;
        }

        .month-calendar-table td.reserved {
            background: #f8d7da;
            color: #721c24;
            font-weight: 600;
        }

        .month-calendar-table td.my-reservation {
            background: #cce5ff;
            color: #004085;
            font-weight: 600;
        }

        .month-calendar-table td.today {
            border: 2px solid #007bff !important;
        }

        .month-calendar-table td:hover {
            transform: scale(1.05);
            z-index: 1;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            position: relative;
        }

        /* Legenda */
        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #dee2e6;
        }

        .legend-today {
            background: white;
            border: 2px solid #007bff;
        }

        .legend-reserved {
            background: #f8d7da;
        }

        .legend-my-reservation {
            background: #cce5ff;
        }

        .legend-available {
            background: #d4edda;
        }

        /* Statystyki */
        .summary-stats.compact {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .stat-item.compact {
            flex: 1;
            min-width: 180px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 10px;
        }

        .stat-item.compact h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #2a5298;
            font-size: 0.9rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2a5298;
            margin: 5px 0;
        }

        .stat-value.large {
            font-size: 1.3rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin: 0;
        }

        .cars-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .export-options {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-export.excel {
            background: #217346;
        }

        .btn-export.excel:hover {
            background: #1a5c38;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-calendar-alt"></i> Kalendarz miesiąca - Rezerwacje aut służbowych</h1>
            <div class="user-info">
                <span id="userDisplay">Administrator</span>
                <button onclick="window.location.href='index.html'" class="btn-logout">
                    <i class="fas fa-arrow-left"></i> Powrót
                </button>
            </div>
        </header>
        
        <main>
            <div class="calendar-controls">
                <button id="prevMonth" class="btn-nav">
                    <i class="fas fa-chevron-left"></i> Poprzedni miesiąc
                </button>
                <h2 id="currentMonthDisplay" class="month-title">Maj 2023</h2>
                <button id="nextMonth" class="btn-nav">
                    Następny miesiąc <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="month-calendar-container">
                <div class="multi-calendar-grid" id="multiCalendarGrid">
                    <!-- Kalendarze będą generowane dynamicznie -->
                </div>
                
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-today"></div>
                        <span>Dzisiejszy dzień</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-reserved"></div>
                        <span>Zajęte dni</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-my-reservation"></div>
                        <span>Twoje rezerwacje</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-available"></div>
                        <span>Wolne</span>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-info-circle"></i> Instrukcja kalendarza</h3>
                <div class="instructions">
                    <h4><i class="fas fa-list-ol"></i> Jak czytać kalendarz:</h4>
                    <ol>
                        <li>Każde auto ma swój osobny kalendarz miesiąca</li>
                        <li><strong>Zajęte dni</strong> są oznaczone na czerwono - auto jest zarezerwowane</li>
                        <li><strong>Twoje rezerwacje</strong> są oznaczone na niebiesko</li>
                        <li><strong>Dzisiejszy dzień</strong> jest obramowany niebieską linią</li>
                        <li><strong>Wolne dni</strong> są oznaczone na zielono</li>
                        <li><strong>Najedź myszką</strong> na zajęty dzień, aby zobaczyć szczegóły rezerwacji</li>
                    </ol>
                    
                    <h4><i class="fas fa-chart-bar"></i> Statystyki bieżącego miesiąca:</h4>
                    <div id="monthStats" class="summary-stats compact">
                        <!-- Statystyki będą ładowane dynamicznie -->
                    </div>
                    
<!-- Zmień onclick na poprawne funkcje: -->
<div class="export-options">
    <button class="btn-export pdf" onclick="exportMonthCalendarPDF()">
        <i class="fas fa-file-pdf"></i> Eksportuj do PDF
    </button>
    <button class="btn-export excel" onclick="exportMonthCalendarExcel()">
        <i class="fas fa-file-excel"></i> Eksportuj do Excel
    </button>
    <button class="btn-export" onclick="printMonthCalendar()">
        <i class="fas fa-print"></i> Drukuj kalendarz
    </button>
</div>
                </div>
            </div>
        </main>
        
        <footer>
            <p>© 2023 System Rezerwacji Aut Służbowych | Kalendarz miesiąca</p>
            <p id="lastUpdate">Ostatnia aktualizacja: --</p>
        </footer>
    </div>

<script>
    // Dane aut
    const CARS = [
        { id: "Auto1", name: "Skoda Octavia 1", plate: "RZ 12345" },
        { id: "Auto2", name: "Skoda Octavia 2", plate: "RZ 23456" },
        { id: "Auto3", name: "Skoda Octavia 3", plate: "RZ 34567"},
        { id: "Auto4", name: "Skoda Superb", plate: "RZ 45678"},
        { id: "Auto5", name: "Hyundai Tucson 1", plate: "RZ 56789" },
        { id: "Auto6", name: "Hyundai Tucson 2", plate: "RZ 67890" }
    ];

    // Zmienne globalne dla kalendarza
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let currentUser = null;
    let reservations = [];

    // Inicjalizacja po załadowaniu strony
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Inicjalizacja kalendarza miesiąca...');
        
        // Sprawdź czy użytkownik jest zalogowany
        const userData = localStorage.getItem('currentUser');
        if (userData) {
            try {
                currentUser = JSON.parse(userData);
                console.log('Użytkownik:', currentUser);
            } catch (e) {
                console.error('Błąd parsowania danych użytkownika:', e);
            }
        }
        
        if (!currentUser) {
            console.warn('Brak zalogowanego użytkownika, używam domyślnego');
            currentUser = { 
                name: 'Administrator', 
                login: 'admin',
                role: 'admin'
            };
        }
        
        // Ustaw nazwę użytkownika
        document.getElementById('userDisplay').textContent = 'Zalogowany jako: ' + currentUser.name;
        
        // Załaduj rezerwacje
        loadReservations();
        
        // Inicjalizuj kalendarz
        initMultiCarCalendar();
        
        // Dodaj obsługę nawigacji miesiącami
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            initMultiCarCalendar();
        });
        
        document.getElementById('nextMonth').addEventListener('click', function() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            initMultiCarCalendar();
        });
        
        // Dodaj obsługę przycisków
        document.getElementById('exportPdfBtn').addEventListener('click', exportMonthCalendarPDF);
        document.getElementById('exportExcelBtn').addEventListener('click', exportMonthCalendarExcel);
        document.getElementById('printCalendarBtn').addEventListener('click', printMonthCalendar);
        
        // Załaduj statystyki
        updateMonthStats();
        
        // Aktualizuj datę ostatniej aktualizacji
        updateLastUpdate();
    });

    // Załaduj rezerwacje z localStorage
    function loadReservations() {
        const savedReservations = localStorage.getItem('carReservations');
        if (savedReservations) {
            try {
                reservations = JSON.parse(savedReservations);
                console.log('Załadowano rezerwacje:', reservations.length);
            } catch (e) {
                console.error('Błąd parsowania rezerwacji:', e);
                reservations = [];
            }
        } else {
            console.log('Brak zapisanych rezerwacji');
            reservations = [];
            // Dodaj przykładowe rezerwacje dla testów
            addSampleReservations();
        }
    }

    // Inicjalizuj kalendarz dla wszystkich aut
    function initMultiCarCalendar() {
        const calendarGrid = document.getElementById('multiCalendarGrid');
        if (!calendarGrid) {
            console.error('Nie znaleziono kontenera kalendarza!');
            return;
        }
        
        console.log('Inicjalizacja kalendarza dla:', currentMonth, currentYear);
        
        // Ustaw tytuł miesiąca
        const monthNames = [
            'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
            'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'
        ];
        document.getElementById('currentMonthDisplay').textContent = monthNames[currentMonth] + ' ' + currentYear;
        
        // Wyczyść kalendarz
        calendarGrid.innerHTML = '';
        
        // Stwórz kalendarz dla każdego auta
        CARS.forEach(car => {
            const carCalendar = createCarCalendar(car);
            calendarGrid.appendChild(carCalendar);
        });
        
        // Załaduj statystyki ponownie
        updateMonthStats();
    }

    // Stwórz kalendarz dla pojedynczego auta
    function createCarCalendar(car) {
        const calendarDiv = document.createElement('div');
        calendarDiv.className = 'car-calendar';
        
        // Nagłówek kalendarza z nazwą auta
        const header = document.createElement('div');
        header.className = 'car-calendar-header';
        header.innerHTML = '<h3><i class="fas fa-car"></i> ' + car.name + ' (' + car.plate + ')</h3>';
        calendarDiv.appendChild(header);
        
        // Kalendarz dni
        const calendarTable = document.createElement('table');
        calendarTable.className = 'month-calendar-table';
        
        // Nagłówki dni tygodnia
        const dayNames = ['Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'So', 'Nd'];
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        dayNames.forEach(day => {
            const th = document.createElement('th');
            th.textContent = day;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        calendarTable.appendChild(thead);
        
        // Ciało kalendarza
        const tbody = document.createElement('tbody');
        
        // Pobierz pierwszy dzień miesiąca i dzień tygodnia
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        // Oblicz dzień tygodnia pierwszego dnia miesiąca
        let startingDay = firstDay.getDay();
        // Dostosowanie dla polskiego kalendarza (poniedziałek jako pierwszy dzień)
        if (startingDay === 0) {
            startingDay = 6;
        } else {
            startingDay = startingDay - 1;
        }
        
        let dayCounter = 1;
        const today = new Date();
        const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
        
        // Tworzenie 6 wierszy (maksymalnie 6 tygodni w miesiącu)
        for (let week = 0; week < 6; week++) {
            const row = document.createElement('tr');
            
            for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                const cell = document.createElement('td');
                
                // Sprawdź czy to pusty dzień przed początkiem miesiąca lub po końcu
                if ((week === 0 && dayOfWeek < startingDay) || dayCounter > daysInMonth) {
                    cell.className = 'empty-cell';
                    cell.textContent = '';
                    cell.title = '';
                } else {
                    // Normalny dzień miesiąca
                    const dayDate = new Date(currentYear, currentMonth, dayCounter);
                    
                    // Sprawdź czy to dzisiejszy dzień
                    if (isCurrentMonth && dayCounter === today.getDate()) {
                        cell.classList.add('today');
                    }
                    
                    // Sprawdź rezerwacje dla tego dnia i auta
                    const dayReservations = reservations.filter(r => {
                        try {
                            if (!r.startDate) return false;
                            const resDate = new Date(r.startDate);
                            const resEndDate = new Date(r.endDate);
                            const currentDate = new Date(currentYear, currentMonth, dayCounter);
                            
                            return currentDate >= resDate && 
                                   currentDate <= resEndDate &&
                                   r.carId === car.id &&
                                   r.status !== 'cancelled';
                        } catch (e) {
                            console.error('Błąd parsowania daty rezerwacji:', r, e);
                            return false;
                        }
                    });
                    
                    if (dayReservations.length > 0) {
                        // Sprawdź czy to rezerwacja obecnego użytkownika
                        const userReservation = dayReservations.find(r => r.login === currentUser.login);
                        
                        if (userReservation) {
                            cell.classList.add('my-reservation');
                            cell.title = 'Twoja rezerwacja\nCel: ' + (userReservation.purpose || 'brak') + '\nDział: ' + (userReservation.department || 'brak');
                        } else {
                            cell.classList.add('reserved');
                            const firstRes = dayReservations[0];
                            cell.title = 'Zajęte przez: ' + (firstRes.employeeName || 'nieznany') + '\nCel: ' + (firstRes.purpose || 'brak') + '\nDział: ' + (firstRes.department || 'brak');
                        }
                    } else {
                        cell.classList.add('available');
                        cell.title = 'Wolne - dostępne do rezerwacji';
                    }
                    
                    cell.textContent = dayCounter;
                    dayCounter++;
                }
                
                row.appendChild(cell);
            }
            
            tbody.appendChild(row);
            
            // Przerwij jeśli już wypisaliśmy wszystkie dni
            if (dayCounter > daysInMonth) {
                break;
            }
        }
        
        calendarTable.appendChild(tbody);
        calendarDiv.appendChild(calendarTable);
        
        return calendarDiv;
    }

    // Aktualizuj statystyki miesiąca
    function updateMonthStats() {
        const report = generateMonthlyReport(currentMonth + 1, currentYear);
        const statsContainer = document.getElementById('monthStats');
        
        if (!statsContainer) return;
        
        let carsHtml = '';
        
        // Dla każdego auta
        CARS.forEach(car => {
            const carStats = report.byCar[car.id] || { count: 0, days: 0 };
            const shortName = car.name.length > 20 ? car.name.substring(0, 20) + '...' : car.name;
            carsHtml += '<div class="stat-item compact">' +
                        '<h5><i class="fas fa-car"></i> ' + shortName + '</h5>' +
                        '<p class="stat-value">' + carStats.count + '</p>' +
                        '<p class="stat-label">rezerwacji</p>' +
                        '<p class="stat-value">' + carStats.days + '</p>' +
                        '<p class="stat-label">dni</p>' +
                        '</div>';
        });
        
        let departmentsHtml = '';
        if (Object.keys(report.byDepartment).length > 0) {
            departmentsHtml = Object.keys(report.byDepartment).map(dept => {
                const deptStats = report.byDepartment[dept];
                const shortDept = dept.length > 15 ? dept.substring(0, 15) + '...' : dept;
                return '<div class="department-stat">' +
                       '<span class="dept-name">' + shortDept + ':</span>' +
                       '<span class="dept-value">' + deptStats.count + ' rezerwacji</span>' +
                       '</div>';
            }).join('');
        } else {
            departmentsHtml = '<p class="no-data">Brak danych o działach</p>';
        }
        
        statsContainer.innerHTML = '<div class="stat-item compact">' +
                                   '<h4><i class="fas fa-chart-pie"></i> Podsumowanie</h4>' +
                                   '<p class="stat-value large">' + report.totalReservations + '</p>' +
                                   '<p class="stat-label">Łącznie rezerwacji</p>' +
                                   '<p class="stat-value large">' + report.totalDays + '</p>' +
                                   '<p class="stat-label">Łączna liczba dni</p>' +
                                   '</div>' +
                                   '<div class="stat-item compact">' +
                                   '<h4><i class="fas fa-building"></i> Działy</h4>' +
                                   departmentsHtml +
                                   '</div>' +
                                   '<div class="cars-stats" style="flex: 2; min-width: 250px;">' +
                                   '<h4><i class="fas fa-car-side"></i> Statystyki aut</h4>' +
                                   '<div class="cars-grid">' +
                                   carsHtml +
                                   '</div>' +
                                   '</div>';
    }

    // Generuj raport miesięczny
    function generateMonthlyReport(month, year) {
        const report = {
            totalReservations: 0,
            totalDays: 0,
            byCar: {},
            byDepartment: {}
        };
        
        console.log('Generowanie raportu dla miesiąca:', month, 'roku:', year);
        
        // Przetwarzaj rezerwacje
        reservations.forEach(reservation => {
            try {
                if (!reservation.startDate || reservation.status === 'cancelled') return;
                
                const resDate = new Date(reservation.startDate);
                
                // Sprawdź czy rezerwacja jest w żądanym miesiącu i roku
                if (resDate.getMonth() + 1 === month && resDate.getFullYear() === year) {
                    report.totalReservations++;
                    
                    // Oblicz liczbę dni
                    const endDate = new Date(reservation.endDate);
                    const days = Math.ceil((endDate - resDate) / (1000 * 60 * 60 * 24)) + 1;
                    report.totalDays += days;
                    
                    // Statystyki per auto
                    const carId = reservation.carId || 'unknown';
                    if (!report.byCar[carId]) {
                        report.byCar[carId] = { count: 0, days: 0 };
                    }
                    report.byCar[carId].count++;
                    report.byCar[carId].days += days;
                    
                    // Statystyki per dział
                    const dept = reservation.department || 'Nieznany';
                    if (!report.byDepartment[dept]) {
                        report.byDepartment[dept] = { count: 0, days: 0 };
                    }
                    report.byDepartment[dept].count++;
                    report.byDepartment[dept].days += days;
                }
            } catch (e) {
                console.error('Błąd przetwarzania rezerwacji:', reservation, e);
            }
        });
        
        return report;
    }

    // Funkcje dla przycisków
    function exportMonthCalendarPDF() {
        const monthNames = [
            'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
            'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'
        ];
        const monthName = monthNames[currentMonth];
        
        alert('Eksport do PDF dla ' + monthName + ' ' + currentYear + '\n\nAby wyeksportować do PDF, użyj funkcji drukowania przeglądarki (Ctrl+P) i wybierz "Zapisz jako PDF".');
    }

    function exportMonthCalendarExcel() {
        try {
            const monthNames = [
                'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
                'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'
            ];
            const monthName = monthNames[currentMonth];
            
            // Filtruj rezerwacje dla bieżącego miesiąca
            const monthReservations = reservations.filter(res => {
                try {
                    if (!res.startDate || res.status === 'cancelled') return false;
                    const resDate = new Date(res.startDate);
                    return resDate.getMonth() === currentMonth && 
                           resDate.getFullYear() === currentYear;
                } catch (e) {
                    return false;
                }
            });
            
            if (monthReservations.length === 0) {
                alert('Brak rezerwacji dla ' + monthName + ' ' + currentYear);
                return;
            }
            
            // Utwórz CSV
            let csv = 'Data,Auto,Pracownik,Dział,Cel podróży,Liczba dni\n';
            
            monthReservations.forEach(res => {
                const startDate = new Date(res.startDate);
                const endDate = new Date(res.endDate);
                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                const dateStr = startDate.toLocaleDateString('pl-PL');
                const endDateStr = endDate.toLocaleDateString('pl-PL');
                const car = CARS.find(c => c.id === res.carId);
                const carName = car ? car.name + ' (' + car.plate + ')' : res.carId;
                
                csv += '"' + dateStr + ' - ' + endDateStr + '","' + carName + '","' + (res.employeeName || 'Nieznany') + '","' + (res.department || 'Nieznany') + '","' + (res.purpose || 'Brak') + '","' + days + '"\n';
            });
            
            // Pobierz jako plik
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", 'rezerwacje-' + monthName + '-' + currentYear + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Eksport do Excel zakończony!\nPlik: rezerwacje-' + monthName + '-' + currentYear + '.csv\nMożesz otworzyć go w Excelu.');
            
        } catch (error) {
            console.error('Błąd eksportu do Excel:', error);
            alert('Błąd eksportu do Excel: ' + error.message);
        }
    }

    function printMonthCalendar() {
        window.print();
    }

    // Dodaj przykładowe rezerwacje dla testów
    function addSampleReservations() {
        const today = new Date();
        const currentMonthNum = today.getMonth();
        const currentYearNum = today.getFullYear();
        
        const sampleReservations = [
            {
                id: '1',
                carId: "Auto1",
                carName: "Skoda Octavia 1",
                employeeName: "Jan Kowalski",
                department: "IT",
                startDate: new Date(currentYearNum, currentMonthNum, 5).toISOString().split('T')[0],
                endDate: new Date(currentYearNum, currentMonthNum, 7).toISOString().split('T')[0],
                purpose: "Spotkanie z klientem",
                bookingDate: new Date().toISOString().split('T')[0],
                login: "admin",
                status: "active",
                daysCount: 3
            },
            {
                id: '2',
                carId: "Auto2",
                carName: "Skoda Octavia 2",
                employeeName: "Anna Nowak",
                department: "Sprzedaż",
                startDate: new Date(currentYearNum, currentMonthNum, 10).toISOString().split('T')[0],
                endDate: new Date(currentYearNum, currentMonthNum, 12).toISOString().split('T')[0],
                purpose: "Wizyta terenowa",
                bookingDate: new Date().toISOString().split('T')[0],
                login: "pracownik2",
                status: "active",
                daysCount: 3
            },
            {
                id: '3',
                carId: "Auto3",
                carName: "Skoda Octavia 3",
                employeeName: "Jan Kowalski",
                department: "IT",
                startDate: new Date(currentYearNum, currentMonthNum, 15).toISOString().split('T')[0],
                endDate: new Date(currentYearNum, currentMonthNum, 17).toISOString().split('T')[0],
                purpose: "Serwis",
                bookingDate: new Date().toISOString().split('T')[0],
                login: "admin",
                status: "active",
                daysCount: 3
            }
        ];
        
        // Zapisz do localStorage
        localStorage.setItem('carReservations', JSON.stringify(sampleReservations));
        reservations = sampleReservations;
        console.log('Dodano przykładowe rezerwacje');
    }

    // Aktualizuj datę ostatniej aktualizacji
    function updateLastUpdate() {
        const lastUpdateElement = document.getElementById('lastUpdate');
        if (lastUpdateElement) {
            lastUpdateElement.textContent = 'Ostatnia aktualizacja: ' + new Date().toLocaleString('pl-PL');
        }
    }
</script>
<script src="script.js"></script>
<script src="month-calendar-script.js"></script>
</body>

</html>

